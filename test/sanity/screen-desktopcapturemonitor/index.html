<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Screen.DesktopCaptureMonitor</title>
</head>
<body>
  <button type="button" id="startMonitor" onclick="startMonitor()">Start Monitor</button>
  <button type="button" id="stopMonitor" onclick="stopMonitor()">Stop Monitor</button>
  <button type="button" id="newWindow" onclick="newWindow()">New Window</button>
  <script>

  var monitorResult = {added: false, removed: false, namechanged: false, orderchanged: false, thumbnailchanged: false, 
                       streamTrackUndefined:false, streamTrackValid: false, streamTrackNotValid: false};

  function startMonitor() {
    try{
      var winId = null;
      nw.Screen.Init();
      Object.keys(monitorResult).forEach(function(eventName) {
        //once will only give you 1 event
        nw.Screen.DesktopCaptureMonitor.once(eventName, function(id, param2) {
          console.log(id + " " + eventName);
          if (eventName == "namechanged") {
            winId = id; // save the winId of the popup window
            writeSuccess(eventName);
			      monitorResult[eventName] = true;
            if (nw.Screen.DesktopCaptureMonitor.isStreamTrackValid(id) == true) {
              writeSuccess("streamTrackValid");
              monitorResult["streamTrackValid"] = true;
            }
          } else if (eventName == "removed") {
            // id here is the popup window
            if(winId==id) {
              writeSuccess(eventName);
			        monitorResult[eventName] = true;
              if (nw.Screen.DesktopCaptureMonitor.isStreamTrackValid(id) == false) {
                writeSuccess("streamTrackNotValid");
                monitorResult["streamTrackNotValid"] = true;
              }
			      }
          } else if (eventName == "thumbnailchanged") { 
            var i = new Image(); 
            i.onload = function() {
			        if (i.width == 300 || i.height == 300) {
			          writeSuccess(eventName);
				        monitorResult[eventName] = true;
			        }
            };
            i.src = "data:image/png;base64,"+param2; 
		      } else {
            writeSuccess(eventName);
			      monitorResult[eventName] = true;
          }
        })
      });
      nw.Screen.DesktopCaptureMonitor.start(false, true, 300, 300);
      if (nw.Screen.DesktopCaptureMonitor.isStreamTrackValid("") == undefined) {
        writeSuccess("streamTrackUndefined");
        monitorResult["streamTrackUndefined"] = true;
      }
    } catch(e) {
      writeFailure(e);
    }
  }

  function stopMonitor() {
    nw.Screen.DesktopCaptureMonitor.stop();
    if (monitorResult.added && monitorResult.removed && monitorResult.namechanged && monitorResult.orderchanged && 
        monitorResult.thumbnailchanged && monitorResult.streamTrackValid && monitorResult.streamTrackNotValid) {
      writeSuccess();
    } else {
      writeFailure(JSON.stringify(monitorResult));
    }
  }

  function newWindow() {
    open('popup.html', 'mypopup');
  }

  function writeSuccess(id) {
    var result = document.createElement('h1');
    result.setAttribute('id', id || 'result');
    result.innerHTML = id + ' success';
    document.body.appendChild(result);
  }

  function writeFailure(e) {
    var result = document.createElement('h1');
    result.setAttribute('id', 'result');
    result.innerHTML = 'failure [' + e + ']';
    document.body.appendChild(result);
  }
  </script>
</body>
</html>
